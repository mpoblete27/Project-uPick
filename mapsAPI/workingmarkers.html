<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Place Search Pagination</title>








    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    
  
     
      h2 {
        font-size: 22px;
        margin: 0 0 5px 0;
      }
  
   
      #more {
        width: 100%;
        margin: 5px 0 0 0;
      }
    </style>
  </head>
  
  <body>

      

          <div class="container">
              <div class="row">
                  <div class="cuisine-display button">
                  </div>
              </div>
          
              <!-- Display final result-->
              <div class="result"></div>
          </div>
          <br>
          <p class="correct-answer">The pick:
              <div id="correct-answer-id"></div>
              <br>
          
              <hr>
              <div>
                  <h3 class="">Trending:
                      <strong>
                          <span id="connected-viewers"></span>
                      </strong> currently on uPick.</h3>
              </div>

    <div id="map"></div>
    <div id="right-panel">
      <h2>Results</h2>
      <ul id="places"></ul>
      <button id="more">More results</button>
    </div>

    <!-- <div class="list-results"></div> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>

    <script>
      var winner;
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBMHL9um8Nsoy3vj8CPWIZuaG3QvKDgYys",
            authDomain: "upick-d5758.firebaseapp.com",
            databaseURL: "https://upick-d5758.firebaseio.com",
            projectId: "upick-d5758",
            storageBucket: "upick-d5758.appspot.com",
            messagingSenderId: "989534447107"
        };
        firebase.initializeApp(config);
        // Create a variable to reference the database
        var database = firebase.database();
        // -----------------------------
        // connectionsRef references a specific location in our database.
        // All of our connections will be stored in this directory.
        var connectionsRef = database.ref("/connections");
        // '.info/connected' is a special location provided by Firebase that is updated
        // every time the client's connection state changes.
        // '.info/connected' is a boolean value, true if the client is connected and false if they are not.
        var connectedRef = database.ref(".info/connected");
        // When the client's connection state changes...
        connectedRef.on("value", function (snap) {
            // If they are connected..
            if (snap.val()) {
                // Add user to the connections list.
                var con = connectionsRef.push(true);
                // Remove user from the connection list when they disconnect.
                con.onDisconnect().remove();
            }
        });
        // When first loaded or when the connections list changes...
        connectionsRef.on("value", function (snap) {
            // Display the viewer count in the html.
            // The number of online users is the number of children in the connections list.
            $("#connected-viewers").text(snap.numChildren());
        });
        // var cuisines = [{food: 'American', eliminated: false },
        //                 {food: 'Chinese', eliminated: false },
        //                 {food: 'Filipino', eliminated: false },
        //                 {food: 'Indian', eliminated: false },
        //                 {food: 'Italian', eliminated: false },
        //                 {food: 'Japanese', eliminated: false },
        //                 {food: 'Korean', eliminated: false },
        //                 {food: 'Thai', eliminated: false },
        //                 {food: 'Mexican', eliminated: false },
        //                 {food: 'Vietnamese', eliminated: false }]
        var cuisineButton;
        var finalButton;
        // var selectBtn;
 
        
        database.ref("/cuisines").on("value", function (snapshot) {
            cuisines = snapshot.val().cuisines;
            var counter = 0;
            var remainingStuff = [];
            cuisines.forEach(function (cuisine) {
                if (!cuisine.eliminated) {
                    counter++
                    remainingStuff.push(cuisine.food);
                }
            });
            if (counter === 1) {
                 winner = remainingStuff.pop()
                // alert("We have a winner! We gettin' " + winner + " food tonight!!")
                // gameOver();
                $('.cuisine-display').hide();
                $('.correct-answer').append(winner);
            }
            createButtons(cuisines);
        });
        // click handler to start game and generate cuisine buttons
        $('#start-game').on('click', function () {
            resetGameForAll();
        });
        // hide everything, show results
        // function resetGameForAll(){
        //     var cuisines = [{food: 'American', eliminated: false },
        //                     {food: 'Chinese', eliminated: false },
        //                     {food: 'Filipino', eliminated: false },
        //                     {food: 'Indian', eliminated: false },
        //                     {food: 'Italian', eliminated: false },
        //                     {food: 'Japanese', eliminated: false },
        //                     {food: 'Korean', eliminated: false },
        //                     {food: 'Thai', eliminated: false },
        //                     {food: 'Mexican', eliminated: false },
        //                     {food: 'Vietnamese', eliminated: false }];
        //     database.ref('/cuisines').set({
        //         cuisines: cuisines
        //     });
        //     createButtons(cuisines)
        // }
        //when user decides to eliminate one of the cuisines
        $(document).on('click', '.cuisine-button', function () {
            var elimCu = $(this).attr("data-name");
            for (var i = 0; i < cuisines.length; i++) {
                if (elimCu === cuisines[i].food) {
                    cuisines[i].eliminated = true;
                    database.ref("/cuisines").set({
                        cuisines: cuisines
                    })
                }
            }
        });
        function createButtons(cuisines) {
            $('.cuisine-display').empty();
            for (var i = 0; i < cuisines.length; i++) {
                if (!cuisines[i].eliminated) {
                    cuisineButton = $('<button>');
                    cuisineButton.addClass('cuisine-button');
                    cuisineButton.attr('data-name', cuisines[i].food);
                    cuisineButton.text(cuisines[i].food);
                    $('.cuisine-display').append(cuisineButton);
                } else {
                    cuisineButton = $('<button>');
                    cuisineButton.addClass('cuisine-button strike');
                    cuisineButton.attr('data-name', cuisines[i].food);
                    cuisineButton.text(cuisines[i].food);
                    $('.cuisine-display').append(cuisineButton);
                }
            }
        };
        function gameOver() {
            resetGameForAll();
        }
      
    
      var map, infoWindow;
      
      var userLat;
      var userLng;
      var userLoc;
      var service;
      var pos;

      

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: new google.maps.LatLng(userLat, userLng),
          zoom: 15
        });
        infoWindow = new google.maps.InfoWindow;
        // userLoc = new google.maps.LatLng(userLat, userLng);
        console.log(userLoc);
    //   function initMap() {
    //     // Create the map.
    //     var currentLocation = {lat: -33.866, lng: 151.196};
    //     map = new google.maps.Map(document.getElementById('map'), {
    //       center: currentLocation,
    //       zoom: 17
    //     });
//GET USER LOCATION
        if (navigator.geolocation) {
        console.log(navigator.geolocation)
          navigator.geolocation.getCurrentPosition(function(position) {
              console.log(position)
            pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
             userLat = pos.lat;
             userLng = pos.lng;
            console.log(userLat);
            console.log(userLng);
         
            //  userLoc = {lat: userLat, lng: userLng };
            console.log(pos);
            //SHOWS USER POSITION
            infoWindow.setPosition(pos);
            infoWindow.setContent('You are here');
            infoWindow.open(map);
            map.setCenter(pos);
        infowindow = new google.maps.InfoWindow();
            service = new google.maps.places.PlacesService(map);
            service.nearbySearch({
                location: pos,
                radius: 10000,
                type: ['restaurant'], 
                keyword: winner,
            }, callback);
            function callback(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                for (var i = 0; i < results.length; i++) {
                    createMarker(results[i]);
                    // console.log(results);
                    
                  }
                  // finalPicks.push(results);
                }
                // console.log(finalPicks);
            }
         function createMarker(place) {
        var placeLoc = place.geometry.location;
        // var endPoint = {
        //       lat: placeLoc.lat(),
        //       lng: placeLoc.lng()
        //     };
        // debugger;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location
        });
        google.maps.event.addListener(marker, 'click', function() {
        
      // var selectBtn = $('<button>');
      //     selectBtn.addClass("selectButton");
      //     selectBtn.text("Select This Restaurant");
          
  
          infowindow.setContent(place.name + "<br>" + place.vicinity + "<br>" + place.rating + "<br>" + "Price level: " + place.price_level + "<br>" + place.opening_hours.open_now );
          infowindow.open(map, this);
              var directionsService = new google.maps.DirectionsService();
              var directionsDisplay = new google.maps.DirectionsRenderer();
              google.maps.event.addListener(marker, 'click', function() {
  
                    var request = {
                    origin: pos,
                    destination: placeLoc,
                    travelMode: "DRIVING"
                    };
                    // debugger;
  
                directionsService.route(request, function(result, status){
                    if(status == "OK"){
                        // debugger;
                        //shows the directions
                        // debugger;
                        directionsDisplay.setDirections(result);
                    }
                });
                  // } 
                  
                // calculateRoute();
            
                //  }
                  });
        }); 
      
        
///////find places
        
     
///////////////
            
        //   function() {
        //     handleLocationError(true, infoWindow, map.getCenter());
        //   };
        } 
      });
}
}
//////////// showing results to user
// $("#places").append(finalPicks);
          </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBW2P5znpC7asNyzcITnoDRVOutOYjmPzU&callback=initMap&libraries=places"></script>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBW2P5znpC7asNyzcITnoDRVOutOYjmPzU&libraries=places&callback=initMap" async defer></script> -->
  </body>




  
</html>
